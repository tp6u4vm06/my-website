<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ˜“å±…æˆ¿EG Cityï½œé¦–é /è²·å±‹/æ¯”åƒ¹/å¯¦åƒ¹ç™»éŒ„</title>
  <style>
    :root{
      --bg:#1a1a1a;
      --card:#242424;
      --border:#3a3a3a;
      --text-main:#f0f0f0;
      --text-muted:#b2b2b2;
      --blue:#c0c0c0;
      --blue-dark:#9a9a9a;
      --blue-light:#202020;
      --price-color:#ff4d4d;
      --shadow:0 6px 18px rgba(0,0,0,.35);
    }
    
    /* ========================== General ========================== */
    *{ box-sizing:border-box; }
    
    body{
      margin:0;
      background:linear-gradient(180deg, var(--blue-light) 0%, var(--bg) 80%);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
    }
    
    /* ========================== Navbar ========================== */
    .nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 20px;
      background:rgba(18,18,18,.85);
      backdrop-filter:blur(8px);
      position:sticky;top:0;z-index:10;
      box-shadow:var(--shadow);
    }
    
    .nav-links a{
      color:#f0f0f0;
      text-decoration:none;
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
    }
    .nav-links a.active,
    .nav-links a:hover{
      background:#c0c0c0;
      color:#121212;
    }
    
    /* ========================== Hero ========================== */
    .hero{
      max-width:1200px;
      margin:24px auto;
      border-radius:16px;
      position:relative;
      background:url("./images/id8.jpg") center/cover no-repeat;
      box-shadow:var(--shadow);
    }
    .hero::before{
      content:"";position:absolute;inset:0;border-radius:16px;
      background:rgba(0,0,0,.75);
    }
    .hero-inner{
      position:relative;z-index:1;padding:64px 32px;
      display:flex;flex-direction:column;gap:14px;
    }
    
    /* ========================== Controlsï¼ˆç¯©é¸ï¼‰ ========================== */
    .controls{
      max-width:1200px;
      margin:24px auto;
      padding:20px;
      background:#1f1f1f;
      border-radius:12px;
      box-shadow:var(--shadow);
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
    }
    
    .controls .field{
      background:#242424;
      padding:12px;
      border-radius:10px;
      border:1px solid #3a3a3a;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    
    .controls .field input,
    .controls .field select{
      width:100%;
      padding:8px 10px;
      background:#1a1a1a;
      border:1px solid #555;
      border-radius:6px;
      color:white;
    }
    
    /* ========================== Cards ========================== */
    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:20px;
    }
    @media(max-width:1024px){
      .grid{ grid-template-columns:repeat(3,1fr); }
    }
    @media(max-width:760px){
      .grid{ grid-template-columns:repeat(2,1fr); }
    }
    
    .card{
      background:var(--card);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow);
      transition:.2s;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    
    .card .img{
      height:160px;
      background:#333 center/cover no-repeat;
    }
    .card .content{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    
    /* ======== ğŸ”¥ ä¿®æ­£ä½ å£æ‰çš„åœ°æ–¹ï¼šmeta / price / tags ======== */
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .price{
      font-weight:800;
      color:var(--price-color);
    }
    .tags,
    .desc{
      color:var(--text-muted);
    }
    
    /* ======== æŒ‰éˆ•åˆ—ï¼ˆä¿®å¾©è·‘ç‰ˆï¼‰ ======== */
    .card .actions{
      display:flex;
      gap:8px;
      padding:12px;
      border-top:1px solid var(--border);
    }
    
    /* ========================== Buttons ========================== */
    .btn{
      display:flex;
      flex:1;
      justify-content:center;
      align-items:center;
      padding:10px 14px;
      border-radius:8px;
      font-weight:700;
      text-decoration:none;
      cursor:pointer;
      min-height:44px;
    }
    .btn.primary{ background:var(--blue); color:#121212; }
    .btn.primary:hover{ background:var(--blue-dark); }
    .btn.ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text-main);
    }
    .btn.ghost:hover{
      border-color:var(--blue);
      color:var(--blue);
    }
    .btn.link{ background:transparent;color:var(--blue);text-decoration:underline; }
    
    /* ========================== Tables ========================== */
    .table-wrap{
      background:#1f1f1f;
      border-radius:12px;
      overflow-x:auto;
      box-shadow:var(--shadow);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
    }
    th,td{
      padding:12px;
      border-bottom:1px solid #333;
    }
    
    /* ========================== Pager ========================== */
    .pager{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
    }
    .pager .btn{
      flex:0;
      min-width:110px;
      height:44px;
      font-size:16px;
      border-radius:10px;
    }
    </style>
</head>
  
<body>
  <!-- å°è¦½åˆ— -->
  <header class="nav" role="navigation" aria-label="ä¸»é¸å–®">
    <div class="brand">
      <div class="logo"><img src="./images/logo.png" alt="æ˜“å±…æˆ¿ Logo" /></div>
      <div>
        <div style="font-weight:800">æ˜“å±…æˆ¿EG City</div>
        <div style="font-size:12px;color:var(--muted)">æ‰¾æˆ¿ãƒ»æ¯”è¼ƒãƒ»æ±ºç­–</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="#/home" id="nav-home">é¦–é </a>
      <a href="#/buy" id="nav-buy">è²·å±‹</a>
      <a href="#/compare" id="nav-compare">æ¯”åƒ¹</a>
      <a href="#/price" id="nav-price">å¯¦åƒ¹ç™»éŒ„</a>
    </nav>
  </header>

  <main id="app" class="container" aria-live="polite">
    <noscript style="color:#fff">æœ¬ç¶²ç«™éœ€è¦å•Ÿç”¨ JavaScript æ‰èƒ½é‹ä½œ</noscript>
  </main>

  <script>
    /** ========= å·¥å…· ========= **/
    const LISTINGS_DATA = [];
    let PAGE_STATE = { page: 1, pageSize: 100 };
    const formatWan = (wan)=> wan.toLocaleString() + ' è¬';
    const $ = (sel, el=document)=> el.querySelector(sel);
    const $$ = (sel, el=document)=> [...el.querySelectorAll(sel)];
    // å–ä»£åŸæœ¬çš„ num()

    // ç°¡æ˜“ CSV è§£æï¼ˆæ”¯æ´å¼•è™Ÿã€é€—è™Ÿã€æ›è¡Œï¼‰
    function parseCsv(text) {
      const lines = [];
      let row = [], cell = '', q=false;
      for (let i=0;i<text.length;i++){
        const ch = text[i], next = text[i+1];
        if (ch === '"'){
          if (q && next === '"'){ cell += '"'; i++; }
          else { q = !q; }
          continue;
        }
        if (ch === ',' && !q){ row.push(cell); cell=''; continue; }
        if ((ch === '\n' || ch === '\r') && !q){
          if (cell!=='' || row.length){ row.push(cell); lines.push(row); row=[]; cell=''; }
          if (ch === '\r' && next === '\n') i++;
          continue;
        }
        cell += ch;
      }
      if (cell!=='' || row.length){ row.push(cell); lines.push(row); }
      return lines;
    }

    
    /** ====== æ•´åˆä¿¡ç¾©æˆ¿å±‹ CSV æ¬„ä½å°æ‡‰ ====== **/

    // è½‰æ•¸å­—ï¼ˆå»é™¤é€—è™Ÿã€è¬ã€ç©ºç™½ç­‰ï¼‰
    function num(s){
      if(!s) return 0;
      return parseFloat(String(s).replace(/[^\d.]/g,'')) || 0;
    }
    
    /* === æŠŠ #NAME? / N/A / â€” ç­‰ç„¡æ•ˆå­—ä¸²è¦–ç‚ºç©ºå­—ä¸² === */
    const BAD_STR = /^\s*(#NAME\?|N\/A|NA|N\.A\.|â€”|-|ç„¡|null|undefined)\s*$/i;
    function cleanVal(s){
      if(s == null) return '';
      const t = String(s).trim();
      if(!t || BAD_STR.test(t)) return '';
      return t;
    }
    
    // è‡ªå‹•è£œä¸Š https://
    function normalizeUrl(u){
      if(!u) return '';
      const s = String(u).trim();
      if(/^https?:\/\//i.test(s)) return s;
      return 'https://' + s.replace(/^\/+/, '');
    }
    
    // æ¬„ä½å°æ‡‰è¡¨
    const COLS = {
      link:     ["ç‰©ä»¶è¶…é€£çµ","ç‰©ä»¶é€£çµ","æˆ¿å±‹é€£çµ","ç‰©ä»¶ç¶²å€","é€£çµ","ç¶²å€","URL"],
      title:    ["ç‰©ä»¶æ¨™é¡Œ","æ¨™é¡Œ","åç¨±"],
      address:  ["åœ°å€","åœ°é»","åœ°å€","å®Œæ•´åœ°å€","é–€ç‰Œ"],
      type:     ["æˆ¿å±‹é¡å‹","å‹æ…‹","é¡åˆ¥"],
      age:      ["å±‹é½¡","å±‹é½¡(å¹´)","å»ºç¯‰å®Œæˆå¹´æœˆ"],
      areaPing: ["å»ºåª","å»ºç‰©åªæ•¸","æ¬Šç‹€åªæ•¸","å»ºç¯‰é¢ç©(åª)"],
      floor:    ["æ‰€åœ¨æ¨“å±¤","æ¨“å±¤"],
      layout:   ["æ ¼å±€","æˆ¿å»³è¡›","æˆ¿/å»³/è¡›"],
      desc:     ["é¡å¤–è³‡è¨Š2","æè¿°","ç‰¹è‰²","å‚™è¨»"],
      priceWan: ["ç›®å‰åƒ¹æ ¼","åƒ¹æ ¼","ç¸½åƒ¹","å”®åƒ¹","ç¸½åƒ¹(è¬)","é–‹åƒ¹(è¬)"] // â† é—œéµè£œä¸Š
    };

    
    // å¾æ¬„ä½ map å–å€¼çš„å°å·¥å…·
    function getCell(map, names){
      if (!names) return '';                         // å…è¨± undefined
      const list = Array.isArray(names) ? names : [names]; // å…è¨±å‚³å­—ä¸²
      for (const n of list){
        if (map[n] !== undefined){
          const v = cleanVal(map[n]);               // ä½ å…ˆå‰åŠ çš„ cleanVal
          if (v) return v;
        }
      }
      return '';
    }
    
    // å°æ‡‰è½‰æ›ï¼šæŠŠä¿¡ç¾©çš„æ¯ä¸€åˆ—è½‰æˆæ¨™æº–ç‰©ä»¶
    function listingRowToRecord(header, row){
      const map = {};
      header.forEach((h, i)=> map[String(h).trim()] = (row[i] ?? '').toString().trim());
    
      // å…ˆå–æ¬„ä½ï¼ˆå·²è‡ªå‹•æ¸…é™¤ #NAME?/N/Aï¼‰
      const linkRaw  = getCell(map, COLS.link);
      const title    = getCell(map, COLS.title) || 'æœªå‘½åç‰©ä»¶';
      const addr     = getCell(map, COLS.address);
      const type     = getCell(map, COLS.type) || 'ä½å®…';
      const areaPing = num(getCell(map, COLS.areaPing));
      const floor    = getCell(map, COLS.floor);
      const layout   = getCell(map, COLS.layout);
      const ageTxt   = getCell(map, COLS.age);         // å¯èƒ½æ˜¯æ•¸å­—æˆ–å¹´æœˆ
      const extra    = getCell(map, COLS.desc);        // è‹¥ CSV æœ‰ã€Œç‰¹è‰²/æè¿°ã€å°±ä¹Ÿå¸¶ä¸Š
      const priceStr = getCell(map, COLS.priceWan);
    
      // åƒ¹æ ¼ï¼ˆä¿¡ç¾©/æ°¸æ…¶å¸¸è¦‹ï¼š2,188è¬ï¼‰
      const priceWan = num(priceStr);
      if(!addr || !priceWan) return null;
    
      // è‡ªå‹•è£œä¸Š https:// é–‹é ­
      const link = normalizeUrl(linkRaw);
    
      // æ‹†åŸå¸‚/è¡Œæ”¿å€
      const m = addr.match(/^(.*?[ç¸£å¸‚])(.*?[å€é„‰é®å¸‚])(.*)$/);
      const city = m ? m[1] : '';
      const district = m ? m[2] : '';
    
      // å¹´é½¡å­—ä¸²ï¼ˆå¦‚æœ ageTxt å¯è½‰æ•¸å­—ï¼Œå°±é¡¯ç¤ºã€Œå±‹é½¡Xå¹´ã€ï¼›å¦å‰‡ç›´æ¥ç•¥éï¼‰
      let agePart = '';
      const ageNum = num(ageTxt);
      if(ageNum > 0) agePart = `å±‹é½¡${ageNum}å¹´`;
    
      // çµ„åˆç‰¹è‰²ï¼ˆè‡ªå‹•éæ¿¾ç©ºå­—ä¸²ï¼‰
      const descParts = [layout, floor, agePart, extra].filter(Boolean);
      const desc = descParts.length ? descParts.join('ï½œ') : 'â€”';
    
      return {
        id: undefined,
        city,
        type,
        title,
        img: './images/placeholder.jpg',
        desc,                     // â† ä¹¾æ·¨çš„ã€Œç‰¹è‰²ã€å…§å®¹
        priceWan,
        _district: district,
        _addr: addr,
        areaPing,
        link                     // â† é€£çµæ­£è¦åŒ–å¾Œæ”¾é€²ä¾†
      };
    }
    /** ========= æ¯”åƒ¹ ========= **/
    const COMPARE_KEY = 'eg_compare_ids';
    function getCompareIds(){ try { return JSON.parse(localStorage.getItem(COMPARE_KEY) || '[]'); } catch(e){ return []; } }
    function setCompareIds(ids){ localStorage.setItem(COMPARE_KEY, JSON.stringify(ids)); }
    function toggleCompare(id){ const ids = new Set(getCompareIds()); ids.has(id)? ids.delete(id) : ids.add(id); setCompareIds([...ids]); updateCompareBadges(); }
    function inCompare(id){ return getCompareIds().includes(id); }
    function updateCompareBadges(){
      const count = getCompareIds().length;
      const nav = $('#nav-compare');
      if(nav) nav.textContent = count ? `æ¯”åƒ¹(${count})` : 'æ¯”åƒ¹';
      $$('.btn[data-id][data-role="compare"]').forEach(btn=>{
        const id = Number(btn.dataset.id);
        btn.textContent = inCompare(id) ? 'å–æ¶ˆæ¯”è¼ƒ' : 'åŠ å…¥æ¯”è¼ƒ';
      });
    }

    /** ========= æ–°å»ºæ¡ˆ ========= **/
    const NEW_PROJECTS = [
      { id:101, name:"æ°¸åº·çœŸ", builder:"æ°¸åº·å»ºå»ºè¨­", city:"æ–°åŒ—å¸‚æ¿æ©‹å€", priceWanFrom:2061, img:"./images/id101.jpg", highlights:["åºœä¸­é›™åŸå¿ƒ","æ¿å—ç·š450ç±³","é†‡éœå®…"], linkBrochure:"https://newhouse.591.com.tw/138134" },
      { id:102, name:"ä¿¡ç¾©èª å®¶", builder:"èª å®¶èˆˆå»ºè¨­", city:"å°åŒ—å¸‚ä¿¡ç¾©å€", priceWanFrom:92,  img:"./images/id102.jpg", highlights:["å•†åœˆå­¸å€5åˆ†é˜"], linkBrochure:"https://newhouse.591.com.tw/136360" },
      { id:103, name:"ä½³é‹é¦–è€€", builder:"ä½³é‹å»ºå»ºè¨­", city:"å°ä¸­å¸‚æ¢§æ£²å€", priceWanFrom:728, img:"./images/id103.jpg", highlights:["è»Šç«™å•†åœˆ","é›™è»Œå®…"], linkBrochure:"https://newhouse.591.com.tw/137089" }
    ];

    /** ========= å¾…å”®æˆ¿å±‹ï¼šCSV è‡ªå‹•åŒ¯å…¥ï¼ˆå«ç‰©ä»¶è¶…é€£çµï¼‰ ========= **/
    const LISTING_BASE = "./data/";
    const LISTING_FILES = [
      "1_ä¿¡ç¾©æˆ¿å±‹_Kaohsiung_P20.csv",
      "1_ä¿¡ç¾©æˆ¿å±‹_Taipei_P19.csv",
      "1_ä¿¡ç¾©æˆ¿å±‹_NewTaipei_P20.csv",
      "1_ä¿¡ç¾©æˆ¿å±‹_Tainan_P20.csv",
      "1_ä¿¡ç¾©æˆ¿å±‹_Taichung_P20.csv",
      "1_ä¿¡ç¾©æˆ¿å±‹_Keelung_P20.csv",
      "2_æ°¸æ…¶æˆ¿å±‹_å°åŒ—å¸‚_P20.CSV",
      "2_æ°¸æ…¶æˆ¿å±‹_æ–°åŒ—å¸‚_P20.csv",
      "æ°¸æ…¶æˆ¿å±‹_å°åŒ—å¸‚.csv",
      "æ°¸æ…¶æˆ¿å±‹_å°åŒ—å¸‚_20251012_161153.csv",
      "æ°¸æ…¶æˆ¿å±‹_æ¡ƒåœ’å¸‚_20251013_201243.csv",
      "æ°¸æ…¶æˆ¿å±‹_åŸºéš†å¸‚_20251012_211004.csv",
      "æ°¸æ…¶æˆ¿å±‹_æ–°åŒ—å¸‚_20251012_195556.csv",
    ];

    function listingsCsvToRecords(text){
      const rows = parseCsv(text).filter(r => r.length && r.some(x => x && x.trim() !== ''));
      if(!rows.length) return [];
      const header = rows[0].map(h => h.trim());
      const dataRows = rows.slice(1);
      const out = [];
      for(const row of dataRows){
        const rec = listingRowToRecord(header, row);
        if(rec) out.push(rec);
      }
      return out;
    }

    function dedupByKey(arr){
      const seen = new Set();
      const unique = [];
      for(const r of arr){
        const key = [r.city, r._district||"", r.title, r.priceWan, r.areaPing||""].join("|");
        if(!seen.has(key)){ seen.add(key); unique.push(r); }
      }
      unique.sort((a,b)=> b.priceWan - a.priceWan);
      unique.forEach((r,i)=> r.id = i+1);
      return unique;
    }

    let LISTINGS_READY = false;
    async function autoLoadListingsFromPresetSilent(){
      if (LISTINGS_READY) return;
      const texts = [];
      for(const name of LISTING_FILES){
        try{
          const res = await fetch(LISTING_BASE + name);
          if(!res.ok) continue;
          texts.push(await res.text());
        }catch(e){}
      }
      if(!texts.length){
        console.warn("æ‰¾ä¸åˆ°å¾…å”® CSVï¼Œè«‹ç¢ºèª ./data/ èˆ‡æª”åã€‚");
        return;
      }
      const all = [];
      for(const t of texts) all.push(...listingsCsvToRecords(t));
      const merged = dedupByKey(all);
      LISTINGS_DATA.length = 0;
      LISTINGS_DATA.push(...merged);
      LISTINGS_READY = true;
    
      console.log("[LISTINGS] å·²è¼‰å…¥", LISTINGS_DATA.length, "ç­†è³‡æ–™");
      let PAGE_STATE = { page: 1, pageSize: 100 };
      updateCompareBadges();
    }

    /** ========= å¡ç‰‡èˆ‡é é¢ï¼ˆå«é€£çµæŒ‰éˆ•ï¼‰ ========= **/
    function card(item){
      const cityDist = item.city + (item._district ? " " + item._district : "");
      return `
        <article class="card" aria-label="æˆ¿å±‹å¡ç‰‡">
          <div class="img" style="background-image:url('${item.img}')" role="img" aria-label="${item.title}"></div>
          <div class="content">
            <div class="meta">
              <div>
                <!-- csv[ç‰©ä»¶æ¨™é¡Œ] -->
                <div style="font-weight:600">${item.title}</div>
                <!-- csv[åŸå¸‚][åœ°å€][æˆ¿å±‹é¡å‹] -->
                <div class="tags">${cityDist} â€¢ ${item.type}</div>
              </div>
              <!-- åƒ¹æ ¼ç±¤ -->
              <div class="price" style="font-size:12px;">NT$ ${formatWan(item.priceWan)}</div>
            </div>
          </div>

          <div class="actions">
            <button class="btn ghost" onclick="viewDetail(${item.id})">æ›´å¤š</button>
            <button class="btn" data-role="compare" data-id="${item.id}" onclick="toggleCompare(${item.id})" style="font-size:12px;">${ inCompare(item.id) ? 'å–æ¶ˆæ¯”è¼ƒ' : 'åŠ å…¥æ¯”è¼ƒ' }</button>
            ${ item.link ? `<a class="btn primary" href="${item.link}" target="_blank" rel="noopener">é€£çµ</a>` : '' }
          </div>
        </article>`;
    }

    function projectCard(p){
      return `
        <article class="card">
          <div class="img" style="background-image:url('${p.img}')" role="img" aria-label="${p.name}"></div>
          <div class="content">
            <div class="meta">
              <div style="font-weight:800">${p.name}</div>
              <div class="tags">${p.city} â€¢ ${p.builder}</div>
            </div>
            <div class="desc">${ p.highlights.map(h => '#' + h).join(' ') }</div>
          </div>
          <div class="actions">
            <button class="btn ghost">é–‹åƒ¹ç´„ NT$ ${formatWan(p.priceWanFrom)}</button>
            <a href="${p.linkBrochure}" target="_blank" class="btn link" rel="noopener">é ç´„è³å±‹</a>
          </div>
        </article>`;
    }

    function Controls({ showSort=false }) {
      const typeOptions = [
        "å¤§æ¨“","å…¬å¯“","é€å¤©","åˆ¥å¢…","åº—é¢","è¾¦å…¬","è¯å»ˆ"
      ];
    
      return `
      <section class="controls" role="region" aria-label="ç¯©é¸å·¥å…·">
    
        <div class="field">
          <label for="search-city">åœ°å€æœå°‹</label>
          <input id="search-city" type="text" placeholder="è¼¸å…¥åŸå¸‚æˆ–è¡Œæ”¿å€ï¼ˆä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚ï¼‰">
        </div>
    
        <div class="field">
          <label for="search-road">è·¯æ®µ</label>
          <input id="search-road" type="text" placeholder="è¼¸å…¥è·¯åé—œéµå­—ï¼ˆä¾‹å¦‚ï¼šå¿ å­æ±è·¯ï¼‰">
        </div>
    
        <div class="field">
          <label>åƒ¹æ ¼ï¼ˆè¬ï¼‰</label>
          <div class="range-inline">
            <input id="min-price" type="number" placeholder="æœ€ä½ (è¬)" min="0" style="width:120px">
            <input id="max-price" type="number" placeholder="æœ€é«˜ (è¬)" min="0" style="width:120px">
          </div>
        </div>
        
        <div class="field">
          <label>æˆ¿å±‹å‹æ…‹ï¼ˆå¯å¤šé¸ï¼‰</label>
    
          <div class="multi-select" id="type-dropdown">
            <div class="multi-select-header">
              <span id="type-placeholder">å…¨éƒ¨</span>
              <span>â–¼</span>
            </div>
            <div class="multi-select-list">
              ${typeOptions.map(t => `
                <label class="multi-item">
                  <input type="checkbox" class="chk-type" value="${t}">
                  ${t}
                </label>
              `).join('')}
            </div>
          </div>
        </div>
    
        ${ showSort ? `
        <div class="field">
          <label for="sort">æ’åº</label>
          <select id="sort">
            <option value="relevance">ç›¸é—œæ€§</option>
            <option value="price_asc">åƒ¹æ ¼ï¼šç”±ä½åˆ°é«˜</option>
            <option value="price_desc">åƒ¹æ ¼ï¼šç”±é«˜åˆ°ä½</option>
          </select>
        </div>
        `:''}
    
        <div class="btns">
          <button id="btn-search" class="btn primary">æœå°‹</button>
          <button id="btn-reset" class="btn ghost">é‡è¨­</button>
        </div>
    
      </section>`;
    }

    function PageHome(){
      const top6 = (LISTINGS_DATA.length ? [...LISTINGS_DATA] : []).sort((a,b)=> b.priceWan - a.priceWan).slice(0,6);
      const newsRows = [
        { title:"åœ°ç”¢å¤©ä¸‹", source:"è‡ªç”±æ™‚å ±", url:"https://estate.ltn.com.tw/" },
        { title:"æˆ¿å¸‚å³æ™‚", source:"å·¥å•†æ™‚å ±", url:"https://www.ctee.com.tw/livenews/house" },
        { title:"591 æˆ¿å¸‚æ–°è", source:"591", url:"https://news.591.com.tw/" },
      ].map(n => '<tr><td>' + n.title + '</td><td>' + n.source + '</td><td><a class="btn link" href="' + n.url + '" target="_blank" rel="noopener">æŸ¥çœ‹</a></td></tr>').join('');
      return `
        <section class="hero" aria-label="ä¸»è¦–è¦º">
          <div class="hero-inner">
            <h1>æ‰¾åˆ°ä½ ç†æƒ³çš„å®¶</h1>
            <p>ä¾åœ°å€ã€åƒ¹æ ¼èˆ‡æˆ¿å‹å¿«é€Ÿç¯©é¸ï¼Œä¸¦æä¾›è©³ç´°è³‡è¨Šèˆ‡æ¯”è¼ƒåŠŸèƒ½ã€‚</p>
            <a class="cta" href="#/buy">æˆ‘è¦æ‰¾æˆ¿</a>
          </div>
        </section>
        ${Controls({ showSort:true })}
        <section>
          <h2 class="section-title">ç†±é–€ç‰©ä»¶</h2>
          ${ top6.length
            ? `<div class="grid">${ top6.map(card).join('') }</div>`
            : `<div class="desc" style="color:var(--muted)">å°šæœªè¼‰å…¥å¾…å”®è³‡æ–™ï¼Œè«‹ç¨å€™æˆ–å‰å¾€è²·å±‹é é¢ã€‚</div>` }
        </section>
        <section style="margin-top:28px;">
          <h2 class="section-title">æ–°å»ºæ¡ˆ</h2>
          <div class="grid">${ NEW_PROJECTS.map(projectCard).join('') }</div>
        </section>
        <section style="margin-top:28px;">
          <h2 class="section-title">å³æ™‚æ–°è</h2>
          <div class="table-wrap">
            <table aria-label="æˆ¿å¸‚æ–°è">
              <thead><tr><th style="width:60%">æ¨™é¡Œ</th><th>ä¾†æº</th><th>é€£çµ</th></tr></thead>
              <tbody>${newsRows}</tbody>
            </table>
          </div>
        </section>
      `;
    }

    function PageBuy(){
      return `
        <h2 class="section-title">å¾…å”®æˆ¿å±‹</h2>
        ${Controls({ showSort:true })}
        <div id="no-results" style="display:none;margin-top:18px;color:var(--muted)">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æˆ¿æºã€‚</div>
        <div id="grid" class="grid" aria-live="polite"></div>
      `;
    }

    function PageCompare(){
      const ids = getCompareIds();
      const items = LISTINGS_DATA.filter(d=> ids.includes(d.id));
    
      // æ²’é¸æ“‡ä»»ä½•ç‰©ä»¶æ™‚é¡¯ç¤ºæç¤º
      if (!items.length) {
        return `
          <h2 class="section-title">æˆ¿å±‹æ¯”åƒ¹</h2>
          <div style="color:var(--text-muted);margin:20px 0;">å°šæœªåŠ å…¥ä»»ä½•ç‰©ä»¶ã€‚</div>
          <div class="pager">
            <button class="btn primary" onclick="route('#/buy')">å›åˆ°è²·å±‹åˆ—è¡¨</button>
          </div>
        `;
      }
    
      // è¡¨æ ¼å…§å®¹ï¼šæ¯ç­†ç‰©ä»¶ä¸€åˆ—
      const rows = items.map(it => `
        <tr>
          <td><div class="img" style="height:100px;background-image:url('${it.img}')"></div></td>
          <td>${it.title}</td>
          <td>${it.city}${it._district ? ' ' + it._district : ''}</td>
          <td>${it.type}</td>
          <td>NT$ ${formatWan(it.priceWan)}</td>
          <td>${it.desc || 'â€”'}</td>
          <td>${ it.link ? `<a class="btn primary" href="${it.link}" target="_blank" rel="noopener" font-size="14px">å‰å¾€</a>` : 'â€”' }</td>
          
        </tr>
      `).join('');
    
      return `
        <h2 class="section-title">æˆ¿å±‹æ¯”åƒ¹ï¼ˆ${ids.length}ï¼‰</h2>
        <div class="table-wrap">
          <table aria-label="æ¯”åƒ¹è¡¨">
            <thead>
              <tr>
                <th>åœ–ç‰‡</th>
                <th>æ¨™é¡Œ</th>
                <th>åœ°é»</th>
                <th>å‹æ…‹</th>
                <th>åƒ¹æ ¼</th>
                <th>ç‰¹è‰²</th>
                <th>é€£çµ</th>
                
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div class="pager">
          <button class="btn ghost" onclick="clearCompareAndRerender()">æ¸…ç©ºæ¸…å–®</button>
          <button class="btn primary" onclick="route('#/buy')">å›åˆ°è²·å±‹åˆ—è¡¨</button>
        </div>
      `;
    }

    /** ========= è²·å±‹ç¯©é¸/æ’åº ========= **/
    function getFilters(){
      return {
        city: ($('#search-city')?.value || '').trim().toLowerCase(),
        road: ($('#search-road')?.value || '').trim().toLowerCase(),  // æ–°å¢è·¯æ®µ
        minPrice: Number($('#min-price')?.value) || 0,
        maxPrice: Number($('#max-price')?.value) || Infinity,
        types: $$('.chk-type:checked').map(c => c.value),   // å¤šé¸
        sort: $('#sort')?.value || 'relevance'
      };
    }
    function applyFilters(){
      PAGE_STATE.page = 1;  // ç¯©é¸æ™‚è‡ªå‹•å›åˆ°ç¬¬ 1 é 
      const grid = $('#grid'); if(!grid) return;
      const f = getFilters();
      let results = LISTINGS_DATA.filter(d=>{
        const cityDist = (d.city + ' ' + (d._district || '')).toLowerCase();
        const addrFull = (d._addr || '').toLowerCase();
      
        const matchCity = !f.city || cityDist.includes(f.city);
        const matchRoad = !f.road || addrFull.includes(f.road);
        const matchType =
          !f.types.length ||
          f.types.some(t => (d.type || '').includes(t));
        const matchPrice = d.priceWan >= f.minPrice && d.priceWan <= f.maxPrice;
      
        return matchCity && matchRoad && matchType && matchPrice;
      });
      if(f.sort === 'price_asc') results.sort((a,b)=>a.priceWan - b.priceWan);
      else if(f.sort === 'price_desc') results.sort((a,b)=>b.priceWan - a.priceWan);
      renderList(results);
    }
    function renderList(items){
      const grid = $('#grid'); 
      const noResults = $('#no-results');
      if(!grid) return;
    
      // å¦‚æœæ²’æœ‰è³‡æ–™
      if(!items.length){ 
        noResults && (noResults.style.display='block'); 
        grid.innerHTML = ''; 
        $('#pager-buy')?.remove(); // ç§»é™¤èˆŠçš„åˆ†é 
        return; 
      } else { 
        noResults && (noResults.style.display='none'); 
      }
    
      // åˆ†é è™•ç†
      const total = items.length;
      const pages = Math.ceil(total / PAGE_STATE.pageSize);
      PAGE_STATE.page = Math.min(PAGE_STATE.page, pages);
      const start = (PAGE_STATE.page - 1) * PAGE_STATE.pageSize;
      const end = start + PAGE_STATE.pageSize;
      const pageItems = items.slice(start, end);
    
      // æ¸²æŸ“å¡ç‰‡
      grid.innerHTML = pageItems.map(card).join('');
    
      // æ›´æ–°é ç¢¼é¡¯ç¤º
      let pager = $('#pager-buy');
      if(!pager){
        pager = document.createElement('div');
        pager.id = 'pager-buy';
        pager.className = 'pager';
        grid.insertAdjacentElement('afterend', pager);
      }
    
      pager.innerHTML = `
      <span style="margin-right:auto;color:var(--text-muted);">
        å…± ${total} ç­†ï¼Œç¬¬ ${PAGE_STATE.page} / ${pages} é 
      </span>
      <button class="btn ghost" id="btn-prev-buy" ${PAGE_STATE.page<=1?'disabled':''}>ä¸Šä¸€é </button>
      <button class="btn primary" id="btn-next-buy" ${PAGE_STATE.page>=pages?'disabled':''}>ä¸‹ä¸€é </button>
    `;
    
    // â† æ–°å¢å°å·¥å…·ï¼šå¹³æ»‘æ²åˆ°é é¢æœ€ä¸Šæ–¹ï¼ˆé¿é–‹ sticky å°è¦½åˆ—å¯è‡ªè¡ŒåŠ  offsetï¼‰
    const goTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
    
    $('#btn-prev-buy')?.addEventListener('click', ()=>{
      if(PAGE_STATE.page>1){ 
        PAGE_STATE.page--; 
        renderList(items);
        goTop();            // â˜… åˆ‡é å¾Œæ²åˆ°ä¸Šæ–¹
      }
    });
    $('#btn-next-buy')?.addEventListener('click', ()=>{
      if(PAGE_STATE.page<pages){ 
        PAGE_STATE.page++; 
        renderList(items);
        goTop();            // â˜… åˆ‡é å¾Œæ²åˆ°ä¸Šæ–¹
      }
    });
    
      updateCompareBadges();
    }
    /** ========= å¯¦åƒ¹ç™»éŒ„ï¼ˆç¶­æŒåŸåŠŸèƒ½ï¼‰ ========= **/
    const PRICE_DATA = [];
    const priceState = { sortKey:'date', sortDir:'desc', page:1, pageSize:100, filters:{} };

    function toYearMonth(s){
      if(!s) return '';
      const t = String(s).trim();
      const rocDigits = t.replace(/\D/g,'');
      if (rocDigits.length===7 || rocDigits.length===8){
        const y3 = rocDigits.slice(0,3);
        const rest = rocDigits.slice(3);
        const y = 1911 + parseInt(y3,10);
        const m = rest.slice(0,2);
        return `${y}-${m}`;
      }
      const m1 = t.match(/^(\d{4})[-\/](\d{1,2})(?:[-\/]\d{1,2})?$/);
      if (m1) { const y=m1[1], m=String(m1[2]).padStart(2,'0'); return `${y}-${m}`; }
      return '';
    }
    function buildYmToDate(val){
      if(!val) return null;
      let s = String(val).trim();
      s = s.replace(/[^\d]/g, ""); // ä¿ç•™æ•¸å­—
    
      // 6 ç¢¼ï¼šROC YYYMMDDï¼Œä¾‹å¦‚ 830620 â†’ æ°‘åœ‹83å¹´06æœˆ
      if (s.length === 6){
        const y = 1911 + parseInt(s.slice(0,3),10);
        const m = parseInt(s.slice(3,5),10);
        return new Date(y, m - 1, 1);
      }
    
      // 7 ç¢¼ï¼šROC YYYMMDDï¼Œä¾‹å¦‚ 1120327
      if (s.length === 7){
        const y = 1911 + parseInt(s.slice(0,3),10);
        const m = parseInt(s.slice(3,5),10);
        return new Date(y, m - 1, 1);
      }
    
      // 8 ç¢¼ï¼šYYYYMMDDï¼Œä¾‹å¦‚ 20220531
      if (s.length === 8){
        const y = parseInt(s.slice(0,4),10);
        const m = parseInt(s.slice(4,6),10);
        return new Date(y, m - 1, 1);
      }
    
      return null;
    }
    function calcAgeYears(buildDate, now = new Date()){
      if (!buildDate || isNaN(buildDate.getTime())) return 0;
      let years = now.getFullYear() - buildDate.getFullYear();
      const mNow = now.getMonth();
      const mBuild = buildDate.getMonth();
      if (mNow < mBuild) years -= 1;
      return Math.max(0, years);
    }
    function splitCityDist(addr){
      if(!addr) return { city:'', district:'', road: addr || '' };
      const s = String(addr);
      const m = s.match(/^(.*?[ç¸£å¸‚])(.*?[å€é„‰é®å¸‚])(.*)$/);
      if (m) return { city: m[1].trim(), district: m[2].trim(), road: m[3].trim() };
      const mCity = s.match(/^(.*?[ç¸£å¸‚])(.*)$/);
      if (mCity) return { city: mCity[1].trim(), district: '', road: mCity[2].trim() };
      return { city:'', district:'', road: s.trim() };
    }

    function rowToRecord(header, row) {
      const map = {};
      header.forEach((h, idx) => map[String(h).trim()] = (row[idx] ?? '').toString().trim());
    
      // åœ°å€
      const åœ°å€ = map['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'] || '';
      const addrParts = splitCityDist(åœ°å€);
      
      // åŸå¸‚ / è¡Œæ”¿å€
      const city = addrParts.city;
      const district = map['é„‰é®å¸‚å€'] || addrParts.district;
    
      // å»ºç‰©å‹æ…‹ï¼ˆéœ€è¦æ¸…æ½”æ–‡å­—ï¼Œä¾‹å¦‚ï¼šè¯å»ˆ(10å±¤å«ä»¥ä¸‹æœ‰é›»æ¢¯) â†’ è¯å»ˆï¼‰
      let rawType = map['å»ºç‰©å‹æ…‹'] || map['äº¤æ˜“æ¨™çš„'] || '';
      rawType = rawType.replace(/\(.+\)/g, ""); // å»æ‹¬è™Ÿå…§å®¹
      rawType = rawType.replace(/[ï¼ˆ(].+[ï¼‰)]/g, ""); // å…¨å½¢åŠå½¢ä¸€èµ·è™•ç†
      rawType = rawType.trim();
    
      // é¢ç©ï¼ˆåªï¼‰
      const bAreaM2 = num(map['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']);  // m2
      const areaPing = bAreaM2 ? (bAreaM2 / 3.305785) : 0;
    
      // å–®åƒ¹ï¼ˆè¬/åªï¼‰
      const unitPerM2 = num(map['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']);
      let unitWanPerPing = 0;
      if (unitPerM2) {
        unitWanPerPing = (unitPerM2 * 3.305785) / 10000;
      }
    
      // ç¸½åƒ¹ï¼ˆè¬ï¼‰
      const totalWan = num(map['ç¸½åƒ¹å…ƒ']) / 10000;
    
      // å»ºç¯‰å®Œæˆå¹´æœˆ â†’ å»ºç¯‰å¹´ä»½ / å±‹é½¡
      const buildDate = buildYmToDate(map['å»ºç¯‰å®Œæˆå¹´æœˆ']);
      const ageYears = calcAgeYears(buildDate);
    
      // äº¤æ˜“å¹´æœˆæ—¥ â†’ è½‰å¹´-æœˆ
      const date = toYearMonth(map['äº¤æ˜“å¹´æœˆæ—¥']);
    
      // è‹¥ç¼ºäº¤æ˜“æ—¥ or ç¼ºåœ°å€ â†’ ç•¥é
      if (!date || (!city && !district && !addrParts.road)) return null;
    
      const rec = {
        id: undefined,
        date,
        city,
        district,
        addr: addrParts.road || åœ°å€,
        type: rawType,     // â˜… å·²ç¶“ä¹¾æ·¨åŒ–
        areaPing: Number(areaPing.toFixed(2)),
        unitWanPerPing: Number(unitWanPerPing.toFixed(2)),
        totalWan: Math.round(totalWan),
        age: ageYears,
      };
    
      return rec;
    }

    function csvTextToRecords(text) {
      const lines = parseCsv(text).filter(r => r.length && r.some(x => x && x.trim() !== ''));
      if (!lines.length) return [];
      const header = lines[0].map(h => h.trim());
      const dataRows = lines.slice(1);
      const out = [];
      for (const row of dataRows) {
        const rec = rowToRecord(header, row);
        if (rec) out.push(rec);
      }
      return out;
    }
    function dedupRecords(arr){
      const seen = new Set();
      const unique = [];
      for (const r of arr) {
        const key = [r.date,r.city,r.district,r.addr,r.areaPing,r.totalWan].join('|');
        if (!seen.has(key)) { seen.add(key); unique.push(r); }
      }
      unique.sort((a,b)=> a.date>b.date ? -1 : a.date<b.date ? 1 : 0);
      unique.forEach((r,idx)=> r.id = idx+1);
      return unique;
    }
    
    // åˆªé™¤ "ç¬¬ä¸€å­£å°å—.csv","ç¬¬ä¸€å­£é«˜é›„.csv","ç¬¬ä¸€å­£å°ä¸­.csv","ç¬¬ä¸€å­£å°åŒ—.csv","ç¬¬ä¸€å­£æ¡ƒåœ’.csv","ç¬¬ä¸€å­£æ–°åŒ—.csv",
    const PRESET_FILES = [
      "ç¬¬äºŒå­£æ¡ƒåœ’.csv",
      "ç¬¬äºŒå­£å°ä¸­.csv",
      "ç¬¬äºŒå­£å°åŒ—.csv",
      "ç¬¬äºŒå­£å°å—.csv",
      "ç¬¬äºŒå­£é«˜é›„.csv",
      "ç¬¬äºŒå­£æ–°åŒ—.csv",
      "ç¬¬ä¸‰å­£å°ä¸­.csv",
      "ç¬¬ä¸‰å­£å°åŒ—.csv",
      "ç¬¬ä¸‰å­£å°å—.csv",
      "ç¬¬ä¸‰å­£æ¡ƒåœ’.csv",
      "ç¬¬ä¸‰å­£æ–°åŒ—.csv",
      "ç¬¬ä¸‰å­£é«˜é›„.csv",
    ];
    let PRICE_READY = false;
    async function autoLoadFromPresetSilent(){
      if (PRICE_READY) return;   // â† ä¿è­‰åªåŸ·è¡Œä¸€æ¬¡
    
      PRICE_READY = true;        // â† ä¸€é–‹å§‹å°±é–ä½ï¼Œé¿å…éè¿´çˆ†ç‚¸
    
      const base = "./data/";
      const texts = [];
    
      for (const name of PRESET_FILES){
        try {
          const res = await fetch(base + name);
          if (!res.ok) continue;
          texts.push(await res.text());
        } catch(e){}
      }
    
      if (!texts.length){
        console.warn("ç„¡æ³•è¼‰å…¥ä»»ä½•å¯¦åƒ¹ç™»éŒ„ CSV");
        return;
      }
    
      const all = [];
      for (const t of texts) all.push(...csvTextToRecords(t));
    
      const merged = dedupRecords(all);
    
      PRICE_DATA.length = 0;
      PRICE_DATA.push(...merged);
    
      console.log("[PRICE] å·²è¼‰å…¥", PRICE_DATA.length, "ç­†");
    }

    function headerCell(key, label){
      const arrow = priceState.sortKey===key ? (priceState.sortDir==='asc'?'â–²':'â–¼') : '';
      return `<th class="sortable" data-key="${key}">${label} <span class="arrow">${arrow}</span></th>`;
    }
    function ControlsPrice(){
      const typeOptions = [
        "å…¬å¯“",
        "è¯å»ˆ",
        "ä½å®…å¤§æ¨“",
        "å¥—æˆ¿",
        "é€å¤©å",
        "å…¶ä»–"
      ];
    
      return `
      <section class="controls" role="region" aria-label="å¯¦åƒ¹ç¯©é¸">
    
        <div class="field">
          <label>åŸå¸‚</label>
          <input id="p-city" type="text" placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚">
        </div>
    
        <div class="field">
          <label>è¡Œæ”¿å€</label>
          <input id="p-dist" type="text" placeholder="ä¾‹å¦‚ï¼šå¤§å®‰å€">
        </div>
    
        <div class="field">
          <label>è·¯æ®µ</label>
          <input id="p-road" type="text" placeholder="ä¾‹å¦‚ï¼šå¿ å­æ±è·¯">
        </div>
    
        <div class="field">
          <label>å‹æ…‹ï¼ˆå¯å¤šé¸ï¼‰</label>
    
          <div class="multi-select" id="ptype-dropdown">
            <div class="multi-select-header">
              <span id="ptype-placeholder">å…¨éƒ¨</span>
              <span>â–¼</span>
            </div>
            <div class="multi-select-list">
              ${typeOptions.map(t => `
                <label class="multi-item">
                  <input type="checkbox" class="chk-type" value="${t}">
                  ${t}
                </label>
              `).join('')}
            </div>
          </div>
        </div>
    
        <div class="field">
          <label>æˆäº¤æœˆ(èµ·)</label>
          <input id="p-from" type="month">
        </div>
    
        <div class="field">
          <label>æˆäº¤æœˆ(è¿„)</label>
          <input id="p-to" type="month">
        </div>
    
        <div class="field">
          <label>ç¸½åƒ¹(è¬)</label>
          <div class="range-inline">
            <input id="p-min-total" type="number" placeholder="æœ€ä½" min="0" style="width:120px">
            <input id="p-max-total" type="number" placeholder="æœ€é«˜" min="0" style="width:120px">
          </div>
        </div>
    
        <div class="field">
          <label>å–®åƒ¹(è¬/åª)</label>
          <div class="range-inline">
            <input id="p-min-unit" type="number" placeholder="æœ€ä½" min="0" style="width:120px">
            <input id="p-max-unit" type="number" placeholder="æœ€é«˜" min="0" style="width:120px">
          </div>
        </div>

        <div class="field">
          <label>å±‹é½¡(å¹´)</label>
          <div class="range-inline">
            <input id="p-min-age" type="number" placeholder="æœ€ä½" min="0" style="width:120px">
            <input id="p-max-age" type="number" placeholder="æœ€é«˜" min="0" style="width:120px">
          </div>
        </div>
    
        <div class="btns">
          <button id="p-search" class="btn primary">æœå°‹</button>
          <button id="p-reset" class="btn ghost">é‡è¨­</button>
        </div>
    
      </section>`;
    }

    function PagePrice(){
      return `
        <h2 class="section-title">å¯¦åƒ¹ç™»éŒ„</h2>
        ${ControlsPrice()}
        <div class="table-wrap">
          <table aria-label="å¯¦åƒ¹è¡¨" id="price-table">
            <thead>
              <tr>
                ${headerCell('date','æˆäº¤æœˆ')}
                ${headerCell('city','åŸå¸‚')}
                ${headerCell('district','è¡Œæ”¿å€')}
                ${headerCell('addr','è·¯æ®µ')}
                ${headerCell('type','å‹æ…‹')}
                ${headerCell('areaPing','å»ºåª(åª)')}
                ${headerCell('unitWanPerPing','å–®åƒ¹(è¬/åª)')}
                ${headerCell('totalWan','ç¸½åƒ¹(è¬)')}
                ${headerCell('age','å±‹é½¡(å¹´)')}  
              </tr>
            </thead>
            <tbody id="price-tbody"></tbody>
          </table>
        </div>
        <div class="pager">
          <span id="price-info" style="margin-right:auto"></span>
          <button class="btn ghost" id="price-prev">ä¸Šä¸€é </button>
          <button class="btn primary" id="price-next">ä¸‹ä¸€é </button>
        </div>
      `;
    }
    function getPriceFilters(){
      return priceState.filters = {
        city: ($('#p-city')?.value || '').trim(),
        dist: ($('#p-dist')?.value || '').trim(),
        road: ($('#p-road')?.value || '').trim(),
        types: [...$$('.chk-type:checked')].map(c => c.value),
        from: $('#p-from')?.value || '',
        to:   $('#p-to')?.value || '',
        minTotal: Number($('#p-min-total')?.value) || 0,
        maxTotal: Number($('#p-max-total')?.value) || Infinity,
        minUnit:  Number($('#p-min-unit')?.value)  || 0,
        maxUnit:  Number($('#p-max-unit')?.value)  || Infinity,
        minAge: Number($('#p-min-age')?.value) || 0,
        maxAge: Number($('#p-max-age')?.value) || Infinity,
      };
    }

    function applyPrice(){
      const f = getPriceFilters();
      let list = PRICE_DATA.filter(r=>{
        const okCity  = !f.city || r.city.includes(f.city);
        const okDist  = !f.dist || r.district.includes(f.dist);
        const okRoad  = !f.road || r.addr.includes(f.road);
        const okType =
          !f.types.length ||
          f.types.some(t => (r.type || '').includes(t));
        const okFrom  = !f.from || r.date >= f.from;
        const okTo    = !f.to   || r.date <= f.to;
        const okTotal = r.totalWan >= f.minTotal && r.totalWan <= f.maxTotal;
        const okUnit  = r.unitWanPerPing >= f.minUnit && r.unitWanPerPing <= f.maxUnit;
    
        // â˜… æ–°å¢ï¼šå±‹é½¡ç¯©é¸
        const okAge   = r.age >= f.minAge && r.age <= f.maxAge;
    
        return okCity && okDist && okRoad && okType &&
               okFrom && okTo && okTotal && okUnit && okAge;
      });
    
      list.sort((a,b)=>{
        const k = priceState.sortKey;
        const dir = priceState.sortDir==='asc'?1:-1;
        return (a[k] > b[k] ? 1 : a[k] < b[k] ? -1 : 0) * dir;
      });
      renderPrice(list);
    }

    function renderPrice(list){
      const tbody = $('#price-tbody'); if(!tbody) return;
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / priceState.pageSize));
      priceState.page = Math.min(priceState.page, pages);
      const start = (priceState.page - 1) * priceState.pageSize;
      const rows = list.slice(start, start + priceState.pageSize);
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.date}</td>
          <td>${r.city}</td>
          <td>${r.district}</td>
          <td>${r.addr}</td>
          <td>${r.type}</td>
          <td>${r.areaPing}</td>
          <td>${r.unitWanPerPing}</td>
          <td>${r.totalWan}</td>
          <td>${r.age}</td>   <!-- â˜… æ–°å¢ -->
        </tr>
      `).join('');
      const info = $('#price-info');
      if (info) info.textContent = `å…± ${total} ç­†ï¼Œé  ${priceState.page}/${pages}`;
      const prevBtn = $('#price-prev');
      const nextBtn = $('#price-next');
      if (prevBtn) {
        prevBtn.onclick = () => { if (priceState.page > 1) { priceState.page--; applyPrice(); } };
        prevBtn.disabled = priceState.page <= 1;
      }
      if (nextBtn) {
        nextBtn.onclick = () => {
          if (priceState.page * priceState.pageSize < total) { priceState.page++; applyPrice(); }
        };
        nextBtn.disabled = priceState.page >= pages;
      }
      $$('#price-table thead th.sortable').forEach(th => {
        th.onclick = () => {
          const key = th.dataset.key;
          if (priceState.sortKey === key) priceState.sortDir = priceState.sortDir === 'asc' ? 'desc' : 'asc';
          else { priceState.sortKey = key; priceState.sortDir = 'asc'; }
          $('#app').innerHTML = PagePrice();
          bindPriceControls();
          applyPrice();
        };
      });
    }
    function bindPriceControls(){
      $('#p-search')?.addEventListener('click', ()=>{ priceState.page=1; applyPrice(); });
      $('#p-reset')?.addEventListener('click', ()=>{
        ['p-city','p-dist','p-road','p-type','p-from','p-to','p-min-total','p-max-total','p-min-unit','p-max-unit','p-min-age','p-max-age' ].forEach(id=>{
          const el=$('#'+id); if(!el) return; el.value='';
        });
        priceState.page=1;
        priceState.sortKey='date';
        priceState.sortDir='desc';
        applyPrice();
      });
    }

    /** ========= Router ========= **/
    function route(hash){ window.location.hash = hash; }
    function setActiveNav(hash){
      $$('#nav-home, #nav-buy, #nav-compare, #nav-price').forEach(a=>a.classList.remove('active'));
      if(hash.startsWith('#/buy')) $('#nav-buy').classList.add('active');
      else if(hash.startsWith('#/compare')) $('#nav-compare').classList.add('active');
      else if(hash.startsWith('#/price')) $('#nav-price').classList.add('active');
      else $('#nav-home').classList.add('active');
    }

    async function ensureLoadListings(){ await autoLoadListingsFromPresetSilent(); }

    function renderRoute(){
      const h = window.location.hash || '#/home';
      setActiveNav(h);
      const app = $('#app');

      if (h.startsWith('#/buy')) {
        app.innerHTML = PageBuy();
        ensureLoadListings().then(()=>{
          $('#btn-search')?.addEventListener('click', applyFilters);
          $('#btn-reset')?.addEventListener('click', ()=>{
            $('#search-city').value='';
            $('#search-road').value='';
            $('#min-price').value='';
            $('#max-price').value='';
            $('#sort').value='relevance';
          
            // æ¸…ç©ºæ‰€æœ‰å‹æ…‹å¤šé¸ checkbox
            $$('.chk-type').forEach(c => c.checked = false);
          
            renderList(LISTINGS_DATA);
          });
          const q = h.split('?')[1];
            if (q) {
              const p = new URLSearchParams(q);
              if($('#search-city')) $('#search-city').value = p.get('city') || '';
              if($('#search-road')) $('#search-road').value = p.get('road') || ''; // æ–°å¢
              if($('#min-price'))   $('#min-price').value   = p.get('min')  || '';
              if($('#max-price'))   $('#max-price').value   = p.get('max')  || '';
              if($('#type'))        $('#type').value        = p.get('type') || '';
              if($('#sort'))        $('#sort').value        = p.get('sort') || 'relevance';
            }
          renderList(LISTINGS_DATA);
        });
      }
      else if (h.startsWith('#/compare')) {
        app.innerHTML = PageCompare();
      }
      else if (h.startsWith('#/price')) {
        app.innerHTML = PagePrice();
        bindPriceControls();
        autoLoadFromPresetSilent().then(() => {
          applyPrice();
        });
      }
      else {
        app.innerHTML = PageHome();
        ensureLoadListings().then(()=>{
          $('#btn-search')?.addEventListener('click', ()=>{
            const params = new URLSearchParams({
              city: $('#search-city').value || '',
              road: $('#search-road').value || '',   // æ–°å¢
              min:  $('#min-price').value || '',
              max:  $('#max-price').value || '',
              type: $('#type').value || '',
              sort: $('#sort').value || 'relevance'
            });
            route('#/buy?' + params.toString());
          });
          $('#btn-reset')?.addEventListener('click', ()=>{
            $('#search-city').value='';
            $('#search-road').value='';          // æ–°å¢
            $('#min-price').value='';
            $('#max-price').value='';
            $('#type').value='';
            $('#sort').value='relevance';
            updateCompareBadges();
          });
          updateCompareBadges();
        });
      }
      updateCompareBadges();
    }

    window.addEventListener('hashchange', renderRoute);
    window.addEventListener('DOMContentLoaded', renderRoute);

    /** ========= å…¶ä»–äº’å‹• ========= **/
    function viewDetail(id){
      const item = LISTINGS_DATA.find(d=>d.id===id);
      if(!item) return;
      const where = item.city + (item._district ? " " + item._district : "");
      
      // å»ºç«‹ Modal HTML
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.background = 'rgba(0,0,0,0.6)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '9999';
      
      modal.innerHTML = `
        <div style="background:#1f1f1f; color:#f0f0f0; padding:24px; border-radius:12px; max-width:480px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,.5);">
          <h3 style="margin-top:0; font-size:20px;">${item.title}</h3>
          <p><strong>åœ°é»ï¼š</strong>${where}</p>
          <p><strong>æˆ¿å±‹é¡å‹ï¼š</strong>${item.type}</p>
          <p><strong>åƒ¹æ ¼ï¼š</strong>NT$ ${item.priceWan.toLocaleString()} è¬</p>
          <p><strong>è©³ç´°è³‡è¨Šï¼š</strong><br>${item.desc || 'â€”'}</p>
          <div style="text-align:right; margin-top:16px;">
            <button style="padding:8px 14px; border:0; border-radius:8px; background:#c0c0c0; color:#121212; font-weight:700; cursor:pointer;">é—œé–‰</button>
          </div>
        </div>
      `;
    
      modal.querySelector('button').onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    function contactAgent(id){
      const item = LISTINGS_DATA.find(d=>d.id===id);
      if(!item) return;
      const name = encodeURIComponent(item.title);
      window.location.href = `mailto:agent@example.com?subject=æˆ‘è¦è«®è©¢%20${name}&body=æ‚¨å¥½ï¼Œæˆ‘æƒ³äº†è§£ ${name} çš„æ›´å¤šè³‡è¨Šã€‚`;
    }

    function clearCompareAndRerender(){
      setCompareIds([]);     // æ¸…ç©º localStorage
      updateCompareBadges(); // æ›´æ–°å°è¦½åˆ—ä¸Šçš„ã€Œæ¯”åƒ¹(...)ã€
      route('#/compare');    // åœç•™åœ¨æ¯”åƒ¹é ï¼ˆæˆ–ä½ æƒ³è·³å›è²·å±‹å¯æ”¹æˆ '#/buy'ï¼‰
      renderRoute();         // ç›´æ¥é‡ç•«ç•«é¢ï¼Œä¸ç”¨ F5
    }
    // === ä¸‹æ‹‰å¼å‹æ…‹å¤šé¸æ§åˆ¶ ===
    document.addEventListener('click', (e)=>{
      const dropdowns = $$('.multi-select');
    
      dropdowns.forEach(dd=>{
        const header = dd.querySelector('.multi-select-header');
    
        // é»åˆ° header â†’ å±•é–‹/æ”¶åˆ
        if(header.contains(e.target)){
          dd.classList.toggle('open');
          return;
        }
    
        // é» checkbox â†’ æ›´æ–°æ¨™é¡Œ
        if(dd.contains(e.target) && e.target.classList.contains('chk-type')){
          updateTypeLabel();
          return;
        }
    
        // é»åˆ°å¤–é¢ â†’ é—œé–‰
        if(!dd.contains(e.target)){
          dd.classList.remove('open');
        }
      });
    });
    
    function updateTypeLabel(){
      const checked = $$('.chk-type:checked').map(c => c.value);
      $$('#type-placeholder, #ptype-placeholder').forEach(label=>{
        if(!label) return;
        if(checked.length === 0) label.textContent = "å…¨éƒ¨";
        else if(checked.length === 1) label.textContent = checked[0];
        else label.textContent = checked.length + " å€‹å·²é¸";
      });
    }
  </script>
</body>
</html>




















