<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>易居房EG City｜首頁/買屋/比價/實價登錄</title>
  <style>
    :root{
      --bg:#1a1a1a;
      --card:#242424;
      --border:#3a3a3a;
      --text-main:#f0f0f0;
      --text-muted:#b2b2b2;
      --blue:#c0c0c0;
      --blue-dark:#9a9a9a;
      --blue-light:#202020;
      font-family:"Noto Sans TC","Helvetica Neue",Arial,sans-serif;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:linear-gradient(180deg,var(--blue-light) 0%,var(--bg) 80%);color:var(--text-main);}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:rgba(18,18,18,.85);backdrop-filter:blur(8px);box-shadow:0 6px 18px rgba(0,0,0,.35);position:sticky;top:0;z-index:10;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo img{height:42px;width:auto;object-fit:contain;border-radius:8px;}
    .nav-links{display:flex;gap:10px;}
    .nav-links a{color:#f0f0f0;text-decoration:none;font-weight:700;font-size:14px;padding:8px 10px;border-radius:8px;}
    .nav-links a.active,.nav-links a:hover{background:#c0c0c0;color:#121212;}
    .container{max-width:1200px;margin:24px auto;padding:0 12px 80px;}
    .section-title{margin:8px 0 14px 4px;font-weight:800;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.35);padding:16px;display:flex;flex-direction:column;justify-content:space-between;}
    .meta{display:flex;justify-content:space-between;align-items:center;}
    .price{font-weight:800;color:var(--blue);}
    .actions{display:flex;gap:8px;margin-top:12px;}
    .btn{flex:1;padding:10px;border-radius:8px;border:0;font-weight:700;cursor:pointer;}
    .btn.primary{background:var(--blue);color:#121212;}
    .btn.primary:hover{background:var(--blue-dark);}
    .controls{background:#1f1f1f;border-radius:12px;padding:16px;margin:20px 0;display:flex;flex-wrap:wrap;gap:12px;}
    input,select{background:#151515;color:var(--text-main);padding:10px;border:1px solid var(--border);border-radius:8px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid #333;}
    th{background:#222;}
  </style>
</head>
<body>
  <header class="nav">
    <div class="brand">
      <div class="logo"><img src="./images/logo.png" alt="易居房"></div>
      <div>
        <div style="font-weight:800">易居房EG City</div>
        <div style="font-size:12px;color:var(--text-muted)">找房・比較・決策</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="#/home" id="nav-home">首頁</a>
      <a href="#/buy" id="nav-buy">買屋</a>
      <a href="#/price" id="nav-price">實價登錄</a>
    </nav>
  </header>

  <main id="app" class="container"></main>

  <script>
    /* ===== 共用工具 ===== */
    const $ = (sel,el=document)=>el.querySelector(sel);
    const $$ = (sel,el=document)=>[...el.querySelectorAll(sel)];
    function formatWan(v){ return isFinite(v)? v.toLocaleString() + " 萬" : "-"; }

    /* ===== 導覽列 ===== */
    function setActiveNav(hash){
      $$('#nav-home,#nav-buy,#nav-price').forEach(a=>a.classList.remove('active'));
      if(hash.startsWith('#/buy')) $('#nav-buy').classList.add('active');
      else if(hash.startsWith('#/price')) $('#nav-price').classList.add('active');
      else $('#nav-home').classList.add('active');
    }

    /* ======== 熱門物件 (首頁) ======== */
    async function loadHotItems(){
      try{
        const res = await fetch('./data/hot_items.csv');
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
        const header = rows[0].map(h=>h.trim());
        const list = rows.slice(1).map(r=>{
          const map={}; header.forEach((h,i)=>map[h]=r[i]);
          return {
            url: map['物件超連結']?.trim(),
            title: map['物件標題']?.trim(),
            address: map['地址']?.trim(),
            type: map['房屋類型']?.trim(),
            priceWan: parseFloat(map['目前價格']?.replace(/[^\d.]/g,'')) || 0
          };
        });
        const grid = $('#hot-grid');
        grid.innerHTML = list.map(d=>`
          <article class="card">
            <div class="meta">
              <div>
                <div style="font-weight:800">${d.title}</div>
                <div class="tags">${d.address} ・ ${d.type}</div>
              </div>
              <div class="price">NT$ ${formatWan(d.priceWan)}</div>
            </div>
            <div class="actions">
              <a class="btn primary" href="${d.url}" target="_blank" rel="noopener">我要買</a>
            </div>
          </article>
        `).join('');
      }catch(e){ console.error("讀取 hot_items.csv 失敗",e); }
    }

    /* ======== 實價登錄 ======== */
    const PRICE_DATA=[];
    const PRESET_FILES=[
      "114年第三季_台北.csv","114年第三季_新北.csv","114年第三季_桃園.csv",
      "114年第三季_台中.csv","114年第三季_台南.csv","114年第三季_高雄.csv"
    ];
    async function loadPrices(){
      const base="./data/"; const all=[];
      for(const n of PRESET_FILES){
        try{const r=await fetch(base+n);const t=await r.text();
          const rows=t.split(/\r?\n/).slice(1);
          for(const line of rows){
            if(!line.trim()) continue;
            const cols=line.split(',');
            if(cols.length<8) continue;
            all.push({date:cols[0],city:cols[1],district:cols[2],addr:cols[3],type:cols[4],areaPing:cols[5],unitWan:cols[6],totalWan:cols[7],age:cols[8]});
          }
        }catch(e){console.warn("讀取失敗",n);}
      }
      PRICE_DATA.push(...all);
      renderPrices();
    }
    function renderPrices(){
      const tbody=$('#price-tbody'); const list=PRICE_DATA.slice(0,100);
      tbody.innerHTML=list.map(r=>`
        <tr>
          <td>${r.date}</td><td>${r.city}</td><td>${r.district}</td>
          <td>${r.addr}</td><td>${r.type}</td>
          <td>${r.areaPing}</td><td>${r.unitWan}</td>
          <td>${r.totalWan}</td><td>${r.age}</td>
        </tr>`).join('');
    }

    /* ======== 頁面切換 ======== */
    function PageHome(){
      return `
        <h2 class="section-title">熱門物件</h2>
        <div id="hot-grid" class="grid">載入中...</div>
      `;
    }
    function PagePrice(){
      return `
        <h2 class="section-title">實價登錄（前100筆）</h2>
        <div class="table-wrap">
          <table><thead><tr>
            <th>成交月</th><th>城市</th><th>行政區</th><th>路段</th>
            <th>型態</th><th>建坪(坪)</th><th>單價(萬/坪)</th>
            <th>總價(萬)</th><th>屋齡</th></tr></thead>
            <tbody id="price-tbody"></tbody>
          </table>
        </div>`;
    }

    async function renderRoute(){
      const h=window.location.hash||"#/home"; setActiveNav(h);
      const app=$("#app");
      if(h.startsWith("#/price")){
        app.innerHTML=PagePrice(); await loadPrices();
      }else{
        app.innerHTML=PageHome(); await loadHotItems();
      }
    }
    window.addEventListener("hashchange",renderRoute);
    window.addEventListener("DOMContentLoaded",renderRoute);
  </script>
</body>
</html>
